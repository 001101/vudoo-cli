#!/usr/bin/env node
const program = require('commander');
const chalk = require('chalk');
const ora = require('ora');
const path = require('path');
const rm = require('rimraf').sync;
const fs = require('fs');
const download_repository = require('download-git-repo');
const shell = require('shelljs');
const generator = require('../lib/generator');
const inquirer = require('inquirer');

const exists = fs.existsSync;

const home = (process.platform === 'win32')? (process.env.HOMEPATH) : (process.env.HOME);
const base_dir_templates = path.join(home, '.cache-vudoo-templates');

program
    .command('init <module-name>')
    .description('Generate a new project from template')
    .option("-t, --template [type]", "specify template (odoo8|odoo9|odoo10|odoo11|simple)", "simple")
    .option("-d, --destination [path]", "Destination of the module", '.')
    .action((name, options) => {
        const template = options.template;
        const repository = generateNameRepository(template);
        const dest_download = path.join(base_dir_templates, template);
        const dest_generate = (options.destination === '.') ? path.resolve('.') : (options.destination);

        checkDest(dest_download); // Create folder destination

        inquirer.prompt([{
            type: 'confirm',
            message: dest_generate === '.'
              ? 'Generate project in current directory?'
              : 'Target directory exists. Continue?',
            name: 'ok'
        }]).then(answers => {
            if (answers.ok){
                downloadAndGenerate(repository, dest_download, dest_generate, name);
            }
        }).catch(console.log);
    });


	const enhanceErrorMessages = (methodName, log) => {
		program.Command.prototype[methodName] = function (...args) {
		    if (methodName === 'unknownOption' && this._allowUnknownOption) {
			    return
		    }
		    this.outputHelp()
		    console.log(`  ` + chalk.red(log(...args)))
		    console.log()
		    process.exit(1)
		}
	}
	  
	enhanceErrorMessages('missingArgument', argName => {
		return `\n Missing required argument ${chalk.yellow(`<${argName}>`)}.`
	})
	  
	enhanceErrorMessages('unknownOption', optionName => {
		return `Unknown option ${chalk.yellow(optionName)}.`
	})
	  
	enhanceErrorMessages('optionMissingArgument', (option, flag) => {
		return `Missing required argument for option ${chalk.yellow(option.flags)}` + (
		  flag ? `, got ${chalk.yellow(flag)}` : ``
		)
	})
		
function generateNameRepository(name){
    const main_repo = 'BMKeros/vudoo-templates';
    switch(name){
        case 'simple': return `${main_repo}#simple`;
        case 'odoo8': return `${main_repo}#odoo8`;
        case 'odoo9': return `${main_repo}#odoo9`
        case 'odoo10': return `${main_repo}#odoo10`;
        case 'odoo11': return `${main_repo}#odoo11`;
        default: return `${main_repo}#simple`;
    }
}

function downloadAndGenerate (repo, dest_download, dest_gen, modulee) {
	const spinner = ora('Downloading template from vudoo-templates');
    spinner.start();
    
    if (exists(dest_download)) rm(dest_download);

    download_repository(repo, dest_download, { clone: false }, err => {
        spinner.stop()
        if (err){ 
            console.log('Failed to download ' + repo + ': ' + err.message.trim())
        }
        else{
            const d = path.join(dest_gen, modulee);
            generator(dest_download, d);
        }
    });
}

function checkDest(dest){
    if (!exists(dest)) shell.mkdir('-p', dest);
}

program.parse(process.argv);
